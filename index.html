<script>
  const supabase = window.supabase.createClient(
    'https://hxzrhryiywtzmoryhqbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  );

  supabase.auth.getSession().then(({ data: { session } }) => {
    if (!session) {
      supabase.auth.signInWithOAuth({ provider: 'github' });
    } else {
      loadDashboard(session.user.id);
    }
  });

  async function startMining() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      document.getElementById("status").innerText = "⛔ Giriş yapılmadan mining yapılamaz.";
      return;
    }

    // ✅ Aynı gün içinde mining yapıldı mı kontrolü
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const isoToday = today.toISOString();

    const { data: previous, error: fetchError } = await supabase
      .from("Mining_Result")
      .select("*")
      .eq("user_id", user.id)
      .gte("created_at", isoToday);

    if (fetchError) {
      document.getElementById("status").innerText = "❌ Veri kontrol hatası.";
      console.error(fetchError);
      return;
    }

    if (previous.length > 0) {
      document.getElementById("status").innerText = "⚠️ Bugün zaten mining yaptınız.";
      return;
    }

    // ⛏ Kazım işlemi
    const { error } = await supabase.from("Mining_Result").insert({
      user_id: user.id,
      earned_ngold: 25,
      platform: "web"
    });

    if (error) {
      document.getElementById("status").innerText = "❌ Hata: " + error.message;
    } else {
      document.getElementById("status").innerText = "✅ Tebrikler, 25 NGOLD kazandınız!";
      loadDashboard(user.id); // 📊 Güncelle
    }
  }

  document.getElementById("miningButton").addEventListener("click", startMining);

  async function loadDashboard(userId) {
    const { data, error } = await supabase
      .from("Mining_Result")
      .select("*")
      .eq("user_id", userId);

    if (error) {
      document.getElementById("dashboard").innerHTML = "❌ Dashboard verisi alınamadı.";
      console.error(error);
      return;
    }

    const totalEarned = data.reduce((sum, row) => sum + (row.earned_ngold || 0), 0);
    const totalMined = data.length;

    document.getElementById("totalEarned").innerText = `Toplam Kazanç: ${totalEarned} NGOLD`;
    document.getElementById("totalMined").innerText = `Toplam Mining Sayısı: ${totalMined}`;
    document.getElementById("dashboard").style.display = "block";
  }
</script>
